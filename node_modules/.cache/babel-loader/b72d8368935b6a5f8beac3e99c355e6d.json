{"ast":null,"code":"import _slicedToArray from \"/home/spren/workspace/slides/advanced/term-03/03_polkadot-js-api/kitties/frontend/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/slicedToArray\";\nimport _defineProperty from \"@babel/runtime/helpers/esm/defineProperty\";\n\nfunction ownKeys(object, enumerableOnly) {\n  var keys = Object.keys(object);\n\n  if (Object.getOwnPropertySymbols) {\n    var symbols = Object.getOwnPropertySymbols(object);\n\n    if (enumerableOnly) {\n      symbols = symbols.filter(function (sym) {\n        return Object.getOwnPropertyDescriptor(object, sym).enumerable;\n      });\n    }\n\n    keys.push.apply(keys, symbols);\n  }\n\n  return keys;\n}\n\nfunction _objectSpread(target) {\n  for (var i = 1; i < arguments.length; i++) {\n    var source = arguments[i] != null ? arguments[i] : {};\n\n    if (i % 2) {\n      ownKeys(Object(source), true).forEach(function (key) {\n        _defineProperty(target, key, source[key]);\n      });\n    } else if (Object.getOwnPropertyDescriptors) {\n      Object.defineProperties(target, Object.getOwnPropertyDescriptors(source));\n    } else {\n      ownKeys(Object(source)).forEach(function (key) {\n        Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key));\n      });\n    }\n  }\n\n  return target;\n} // Copyright 2017-2021 @polkadot/api-derive authors & contributors\n// SPDX-License-Identifier: Apache-2.0\n\n\nimport { catchError, combineLatest, map, of, switchMap } from 'rxjs';\nimport { isFunction, stringToHex } from '@polkadot/util';\nimport { memo } from \"../util/index.js\";\nvar DEMOCRACY_ID = stringToHex('democrac');\n\nfunction queryQueue(api) {\n  return api.query.democracy.dispatchQueue().pipe(switchMap(function (dispatches) {\n    return combineLatest([of(dispatches), api.derive.democracy.preimages(dispatches.map(function (_ref) {\n      var _ref2 = _slicedToArray(_ref, 2),\n          hash = _ref2[1];\n\n      return hash;\n    }))]);\n  }), map(function (_ref3) {\n    var _ref4 = _slicedToArray(_ref3, 2),\n        dispatches = _ref4[0],\n        images = _ref4[1];\n\n    return dispatches.map(function (_ref5, dispatchIndex) {\n      var _ref6 = _slicedToArray(_ref5, 3),\n          at = _ref6[0],\n          imageHash = _ref6[1],\n          index = _ref6[2];\n\n      return {\n        at: at,\n        image: images[dispatchIndex],\n        imageHash: imageHash,\n        index: index\n      };\n    });\n  }));\n}\n\nfunction schedulerEntries(api) {\n  // We don't get entries, but rather we get the keys (triggered via finished referendums) and\n  // the subscribe to those keys - this means we pickup when the schedulers actually executes\n  // at a block, the entry for that block will become empty\n  return api.derive.democracy.referendumsFinished().pipe(switchMap(function () {\n    return api.query.scheduler.agenda.keys();\n  }), switchMap(function (keys) {\n    var blockNumbers = keys.map(function (_ref7) {\n      var _ref7$args = _slicedToArray(_ref7.args, 1),\n          blockNumber = _ref7$args[0];\n\n      return blockNumber;\n    });\n    return blockNumbers.length ? combineLatest([of(blockNumbers), // this should simply be api.query.scheduler.agenda.multi<Vec<Option<Scheduled>>>,\n    // however we have had cases on Darwinia where the indices have moved around after an\n    // upgrade, which results in invalid on-chain data\n    combineLatest(blockNumbers.map(function (blockNumber) {\n      return api.query.scheduler.agenda(blockNumber).pipe( // this does create an issue since it discards all at that block\n      catchError(function () {\n        return of(null);\n      }));\n    }))]) : of([[], []]);\n  }));\n}\n\nfunction queryScheduler(api) {\n  return schedulerEntries(api).pipe(switchMap(function (_ref8) {\n    var _ref9 = _slicedToArray(_ref8, 2),\n        blockNumbers = _ref9[0],\n        agendas = _ref9[1];\n\n    var result = [];\n    blockNumbers.forEach(function (at, index) {\n      (agendas[index] || []).filter(function (opt) {\n        return opt.isSome;\n      }).forEach(function (optScheduled) {\n        var scheduled = optScheduled.unwrap();\n\n        if (scheduled.maybeId.isSome) {\n          var id = scheduled.maybeId.unwrap().toHex();\n\n          if (id.startsWith(DEMOCRACY_ID)) {\n            var _api$registry$createT = api.registry.createType('(u64, ReferendumIndex)', id),\n                _api$registry$createT2 = _slicedToArray(_api$registry$createT, 2),\n                _index = _api$registry$createT2[1];\n\n            var imageHash = scheduled.call.args[0];\n            result.push({\n              at: at,\n              imageHash: imageHash,\n              index: _index\n            });\n          }\n        }\n      });\n    });\n    return result.length ? combineLatest([of(result), api.derive.democracy.preimages(result.map(function (_ref10) {\n      var imageHash = _ref10.imageHash;\n      return imageHash;\n    }))]) : of([[], []]);\n  }), map(function (_ref11) {\n    var _ref12 = _slicedToArray(_ref11, 2),\n        infos = _ref12[0],\n        images = _ref12[1];\n\n    return infos.map(function (info, index) {\n      return _objectSpread(_objectSpread({}, info), {}, {\n        image: images[index]\n      });\n    });\n  }));\n}\n\nexport function dispatchQueue(instanceId, api) {\n  return memo(instanceId, function () {\n    var _api$query$scheduler;\n\n    return isFunction((_api$query$scheduler = api.query.scheduler) === null || _api$query$scheduler === void 0 ? void 0 : _api$query$scheduler.agenda) ? queryScheduler(api) : api.query.democracy.dispatchQueue ? queryQueue(api) : of([]);\n  });\n}","map":{"version":3,"sources":["/home/spren/workspace/slides/advanced/term-03/03_polkadot-js-api/kitties/frontend/node_modules/@polkadot/api-derive/democracy/dispatchQueue.js"],"names":["_defineProperty","ownKeys","object","enumerableOnly","keys","Object","getOwnPropertySymbols","symbols","filter","sym","getOwnPropertyDescriptor","enumerable","push","apply","_objectSpread","target","i","arguments","length","source","forEach","key","getOwnPropertyDescriptors","defineProperties","defineProperty","catchError","combineLatest","map","of","switchMap","isFunction","stringToHex","memo","DEMOCRACY_ID","queryQueue","api","query","democracy","dispatchQueue","pipe","dispatches","derive","preimages","hash","images","dispatchIndex","at","imageHash","index","image","schedulerEntries","referendumsFinished","scheduler","agenda","blockNumbers","args","blockNumber","queryScheduler","agendas","result","opt","isSome","optScheduled","scheduled","unwrap","maybeId","id","toHex","startsWith","registry","createType","call","infos","info","instanceId","_api$query$scheduler"],"mappings":"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","sourcesContent":["import _defineProperty from \"@babel/runtime/helpers/esm/defineProperty\";\n\nfunction ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) { symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); } keys.push.apply(keys, symbols); } return keys; }\n\nfunction _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }\n\n// Copyright 2017-2021 @polkadot/api-derive authors & contributors\n// SPDX-License-Identifier: Apache-2.0\nimport { catchError, combineLatest, map, of, switchMap } from 'rxjs';\nimport { isFunction, stringToHex } from '@polkadot/util';\nimport { memo } from \"../util/index.js\";\nconst DEMOCRACY_ID = stringToHex('democrac');\n\nfunction queryQueue(api) {\n  return api.query.democracy.dispatchQueue().pipe(switchMap(dispatches => combineLatest([of(dispatches), api.derive.democracy.preimages(dispatches.map(([, hash]) => hash))])), map(([dispatches, images]) => dispatches.map(([at, imageHash, index], dispatchIndex) => ({\n    at,\n    image: images[dispatchIndex],\n    imageHash,\n    index\n  }))));\n}\n\nfunction schedulerEntries(api) {\n  // We don't get entries, but rather we get the keys (triggered via finished referendums) and\n  // the subscribe to those keys - this means we pickup when the schedulers actually executes\n  // at a block, the entry for that block will become empty\n  return api.derive.democracy.referendumsFinished().pipe(switchMap(() => api.query.scheduler.agenda.keys()), switchMap(keys => {\n    const blockNumbers = keys.map(({\n      args: [blockNumber]\n    }) => blockNumber);\n    return blockNumbers.length ? combineLatest([of(blockNumbers), // this should simply be api.query.scheduler.agenda.multi<Vec<Option<Scheduled>>>,\n    // however we have had cases on Darwinia where the indices have moved around after an\n    // upgrade, which results in invalid on-chain data\n    combineLatest(blockNumbers.map(blockNumber => api.query.scheduler.agenda(blockNumber).pipe( // this does create an issue since it discards all at that block\n    catchError(() => of(null)))))]) : of([[], []]);\n  }));\n}\n\nfunction queryScheduler(api) {\n  return schedulerEntries(api).pipe(switchMap(([blockNumbers, agendas]) => {\n    const result = [];\n    blockNumbers.forEach((at, index) => {\n      (agendas[index] || []).filter(opt => opt.isSome).forEach(optScheduled => {\n        const scheduled = optScheduled.unwrap();\n\n        if (scheduled.maybeId.isSome) {\n          const id = scheduled.maybeId.unwrap().toHex();\n\n          if (id.startsWith(DEMOCRACY_ID)) {\n            const [, index] = api.registry.createType('(u64, ReferendumIndex)', id);\n            const imageHash = scheduled.call.args[0];\n            result.push({\n              at,\n              imageHash,\n              index\n            });\n          }\n        }\n      });\n    });\n    return result.length ? combineLatest([of(result), api.derive.democracy.preimages(result.map(({\n      imageHash\n    }) => imageHash))]) : of([[], []]);\n  }), map(([infos, images]) => infos.map((info, index) => _objectSpread(_objectSpread({}, info), {}, {\n    image: images[index]\n  }))));\n}\n\nexport function dispatchQueue(instanceId, api) {\n  return memo(instanceId, () => {\n    var _api$query$scheduler;\n\n    return isFunction((_api$query$scheduler = api.query.scheduler) === null || _api$query$scheduler === void 0 ? void 0 : _api$query$scheduler.agenda) ? queryScheduler(api) : api.query.democracy.dispatchQueue ? queryQueue(api) : of([]);\n  });\n}"]},"metadata":{},"sourceType":"module"}