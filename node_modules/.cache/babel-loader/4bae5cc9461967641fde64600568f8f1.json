{"ast":null,"code":"import _slicedToArray from \"/home/spren/workspace/slides/advanced/term-03/03_polkadot-js-api/kitties/frontend/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/slicedToArray\";\nimport _toConsumableArray from \"/home/spren/workspace/slides/advanced/term-03/03_polkadot-js-api/kitties/frontend/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/toConsumableArray\";\n// Copyright 2017-2021 @polkadot/api-derive authors & contributors\n// SPDX-License-Identifier: Apache-2.0\nimport { map, of, switchMap } from 'rxjs';\nimport { BN_ZERO } from '@polkadot/util';\nimport { deriveCache, memo } from \"../util/index.js\";\nimport { filterEras } from \"./util.js\";\nvar CACHE_KEY = 'eraPoints';\n\nfunction mapValidators(_ref) {\n  var individual = _ref.individual;\n  return _toConsumableArray(individual.entries()).filter(function (_ref2) {\n    var _ref3 = _slicedToArray(_ref2, 2),\n        points = _ref3[1];\n\n    return points.gt(BN_ZERO);\n  }).reduce(function (result, _ref4) {\n    var _ref5 = _slicedToArray(_ref4, 2),\n        validatorId = _ref5[0],\n        points = _ref5[1];\n\n    result[validatorId.toString()] = points;\n    return result;\n  }, {});\n}\n\nfunction mapPoints(eras, points) {\n  return eras.map(function (era, index) {\n    return {\n      era: era,\n      eraPoints: points[index].total,\n      validators: mapValidators(points[index])\n    };\n  });\n}\n\nexport function _erasPoints(instanceId, api) {\n  return memo(instanceId, function (eras, withActive) {\n    if (!eras.length) {\n      return of([]);\n    }\n\n    var cached = withActive ? [] : eras.map(function (era) {\n      return deriveCache.get(\"\".concat(CACHE_KEY, \"-\").concat(era.toString()));\n    }).filter(function (value) {\n      return !!value;\n    });\n    var remaining = filterEras(eras, cached);\n    return !remaining.length ? of(cached) : api.query.staking.erasRewardPoints.multi(remaining).pipe(map(function (points) {\n      var query = mapPoints(remaining, points);\n      !withActive && query.forEach(function (q) {\n        return deriveCache.set(\"\".concat(CACHE_KEY, \"-\").concat(q.era.toString()), q);\n      });\n      return eras.map(function (era) {\n        return cached.find(function (cached) {\n          return era.eq(cached.era);\n        }) || query.find(function (query) {\n          return era.eq(query.era);\n        });\n      });\n    }));\n  });\n}\nexport function erasPoints(instanceId, api) {\n  return memo(instanceId, function () {\n    var withActive = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : false;\n    return api.derive.staking.erasHistoric(withActive).pipe(switchMap(function (eras) {\n      return api.derive.staking._erasPoints(eras, withActive);\n    }));\n  });\n}","map":{"version":3,"sources":["/home/spren/workspace/slides/advanced/term-03/03_polkadot-js-api/kitties/frontend/node_modules/@polkadot/api-derive/staking/erasPoints.js"],"names":["map","of","switchMap","BN_ZERO","deriveCache","memo","filterEras","CACHE_KEY","mapValidators","individual","entries","filter","points","gt","reduce","result","validatorId","toString","mapPoints","eras","era","index","eraPoints","total","validators","_erasPoints","instanceId","api","withActive","length","cached","get","value","remaining","query","staking","erasRewardPoints","multi","pipe","forEach","q","set","find","eq","erasPoints","derive","erasHistoric"],"mappings":"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","sourcesContent":["// Copyright 2017-2021 @polkadot/api-derive authors & contributors\n// SPDX-License-Identifier: Apache-2.0\nimport { map, of, switchMap } from 'rxjs';\nimport { BN_ZERO } from '@polkadot/util';\nimport { deriveCache, memo } from \"../util/index.js\";\nimport { filterEras } from \"./util.js\";\nconst CACHE_KEY = 'eraPoints';\n\nfunction mapValidators({\n  individual\n}) {\n  return [...individual.entries()].filter(([, points]) => points.gt(BN_ZERO)).reduce((result, [validatorId, points]) => {\n    result[validatorId.toString()] = points;\n    return result;\n  }, {});\n}\n\nfunction mapPoints(eras, points) {\n  return eras.map((era, index) => ({\n    era,\n    eraPoints: points[index].total,\n    validators: mapValidators(points[index])\n  }));\n}\n\nexport function _erasPoints(instanceId, api) {\n  return memo(instanceId, (eras, withActive) => {\n    if (!eras.length) {\n      return of([]);\n    }\n\n    const cached = withActive ? [] : eras.map(era => deriveCache.get(`${CACHE_KEY}-${era.toString()}`)).filter(value => !!value);\n    const remaining = filterEras(eras, cached);\n    return !remaining.length ? of(cached) : api.query.staking.erasRewardPoints.multi(remaining).pipe(map(points => {\n      const query = mapPoints(remaining, points);\n      !withActive && query.forEach(q => deriveCache.set(`${CACHE_KEY}-${q.era.toString()}`, q));\n      return eras.map(era => cached.find(cached => era.eq(cached.era)) || query.find(query => era.eq(query.era)));\n    }));\n  });\n}\nexport function erasPoints(instanceId, api) {\n  return memo(instanceId, (withActive = false) => api.derive.staking.erasHistoric(withActive).pipe(switchMap(eras => api.derive.staking._erasPoints(eras, withActive))));\n}"]},"metadata":{},"sourceType":"module"}