{"ast":null,"code":"import _slicedToArray from \"/home/spren/workspace/slides/advanced/term-03/03_polkadot-js-api/kitties/frontend/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/slicedToArray\";\nimport _toConsumableArray from \"/home/spren/workspace/slides/advanced/term-03/03_polkadot-js-api/kitties/frontend/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/toConsumableArray\";\n// Copyright 2017-2021 @polkadot/api-derive authors & contributors\n// SPDX-License-Identifier: Apache-2.0\nimport { BehaviorSubject, combineLatest, EMPTY, map, of, startWith, switchMap, tap, toArray } from 'rxjs';\nimport { arrayFlatten, isFunction } from '@polkadot/util';\nimport { memo } from \"../util/index.js\";\nimport { extractContributed } from \"./util.js\";\nvar PAGE_SIZE_K = 1000; // limit aligned with the 1k on the node (trie lookups are heavy)\n\nfunction _getUpdates(api, paraId) {\n  var added = [];\n  var removed = [];\n  return api.query.system.events().pipe(switchMap(function (events) {\n    var changes = extractContributed(paraId, events);\n\n    if (changes.added.length || changes.removed.length) {\n      var _added, _removed;\n\n      var _events$createdAtHash;\n\n      added = (_added = added).concat.apply(_added, _toConsumableArray(changes.added));\n      removed = (_removed = removed).concat.apply(_removed, _toConsumableArray(changes.removed));\n      return of({\n        added: added,\n        addedDelta: changes.added,\n        blockHash: ((_events$createdAtHash = events.createdAtHash) === null || _events$createdAtHash === void 0 ? void 0 : _events$createdAtHash.toHex()) || '-',\n        removed: removed,\n        removedDelta: changes.removed\n      });\n    }\n\n    return EMPTY;\n  }), startWith({\n    added: added,\n    addedDelta: [],\n    blockHash: '-',\n    removed: removed,\n    removedDelta: []\n  }));\n}\n\nfunction _eventTriggerAll(api, paraId) {\n  return api.query.system.events().pipe(switchMap(function (events) {\n    var _events$createdAtHash2;\n\n    var items = events.filter(function (_ref) {\n      var _ref$event = _ref.event,\n          _ref$event$data = _slicedToArray(_ref$event.data, 1),\n          eventParaId = _ref$event$data[0],\n          method = _ref$event.method,\n          section = _ref$event.section;\n\n      return section === 'crowdloan' && ['AllRefunded', 'Dissolved', 'PartiallyRefunded'].includes(method) && eventParaId.eq(paraId);\n    });\n    return items.length ? of(((_events$createdAtHash2 = events.createdAtHash) === null || _events$createdAtHash2 === void 0 ? void 0 : _events$createdAtHash2.toHex()) || '-') : EMPTY;\n  }), startWith('-'));\n}\n\nfunction _getKeysPaged(api, childKey) {\n  var startSubject = new BehaviorSubject(undefined);\n  return startSubject.pipe(switchMap(function (startKey) {\n    return api.rpc.childstate.getKeysPaged(childKey, '0x', PAGE_SIZE_K, startKey);\n  }), tap(function (keys) {\n    setTimeout(function () {\n      keys.length === PAGE_SIZE_K ? startSubject.next(keys[PAGE_SIZE_K - 1].toHex()) : startSubject.complete();\n    }, 0);\n  }), toArray(), // toArray since we want to startSubject to be completed\n  map(function (keyArr) {\n    return arrayFlatten(keyArr);\n  }));\n}\n\nfunction _getAll(api, paraId, childKey) {\n  return _eventTriggerAll(api, paraId).pipe(switchMap(function () {\n    return (// FIXME Needs testing and being enabled\n      // eslint-disable-next-line no-constant-condition\n      isFunction(api.rpc.childstate.getKeysPaged) && false ? _getKeysPaged(api, childKey) : api.rpc.childstate.getKeys(childKey, '0x')\n    );\n  }), map(function (keys) {\n    return keys.map(function (k) {\n      return k.toHex();\n    });\n  }));\n}\n\nfunction _contributions(api, paraId, childKey) {\n  return combineLatest([_getAll(api, paraId, childKey), _getUpdates(api, paraId)]).pipe(map(function (_ref2) {\n    var _ref3 = _slicedToArray(_ref2, 2),\n        keys = _ref3[0],\n        _ref3$ = _ref3[1],\n        added = _ref3$.added,\n        blockHash = _ref3$.blockHash,\n        removed = _ref3$.removed;\n\n    var contributorsMap = {};\n    keys.forEach(function (k) {\n      contributorsMap[k] = true;\n    });\n    added.forEach(function (k) {\n      contributorsMap[k] = true;\n    });\n    removed.forEach(function (k) {\n      delete contributorsMap[k];\n    });\n    return {\n      blockHash: blockHash,\n      contributorsHex: Object.keys(contributorsMap)\n    };\n  }));\n}\n\nexport function contributions(instanceId, api) {\n  return memo(instanceId, function (paraId) {\n    return api.derive.crowdloan.childKey(paraId).pipe(switchMap(function (childKey) {\n      return childKey ? _contributions(api, paraId, childKey) : of({\n        blockHash: '-',\n        contributorsHex: []\n      });\n    }));\n  });\n}","map":{"version":3,"sources":["/home/spren/workspace/slides/advanced/term-03/03_polkadot-js-api/kitties/frontend/node_modules/@polkadot/api-derive/crowdloan/contributions.js"],"names":["BehaviorSubject","combineLatest","EMPTY","map","of","startWith","switchMap","tap","toArray","arrayFlatten","isFunction","memo","extractContributed","PAGE_SIZE_K","_getUpdates","api","paraId","added","removed","query","system","events","pipe","changes","length","_events$createdAtHash","concat","addedDelta","blockHash","createdAtHash","toHex","removedDelta","_eventTriggerAll","_events$createdAtHash2","items","filter","event","data","eventParaId","method","section","includes","eq","_getKeysPaged","childKey","startSubject","undefined","startKey","rpc","childstate","getKeysPaged","keys","setTimeout","next","complete","keyArr","_getAll","getKeys","k","_contributions","contributorsMap","forEach","contributorsHex","Object","contributions","instanceId","derive","crowdloan"],"mappings":"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","sourcesContent":["// Copyright 2017-2021 @polkadot/api-derive authors & contributors\n// SPDX-License-Identifier: Apache-2.0\nimport { BehaviorSubject, combineLatest, EMPTY, map, of, startWith, switchMap, tap, toArray } from 'rxjs';\nimport { arrayFlatten, isFunction } from '@polkadot/util';\nimport { memo } from \"../util/index.js\";\nimport { extractContributed } from \"./util.js\";\nconst PAGE_SIZE_K = 1000; // limit aligned with the 1k on the node (trie lookups are heavy)\n\nfunction _getUpdates(api, paraId) {\n  let added = [];\n  let removed = [];\n  return api.query.system.events().pipe(switchMap(events => {\n    const changes = extractContributed(paraId, events);\n\n    if (changes.added.length || changes.removed.length) {\n      var _events$createdAtHash;\n\n      added = added.concat(...changes.added);\n      removed = removed.concat(...changes.removed);\n      return of({\n        added,\n        addedDelta: changes.added,\n        blockHash: ((_events$createdAtHash = events.createdAtHash) === null || _events$createdAtHash === void 0 ? void 0 : _events$createdAtHash.toHex()) || '-',\n        removed,\n        removedDelta: changes.removed\n      });\n    }\n\n    return EMPTY;\n  }), startWith({\n    added,\n    addedDelta: [],\n    blockHash: '-',\n    removed,\n    removedDelta: []\n  }));\n}\n\nfunction _eventTriggerAll(api, paraId) {\n  return api.query.system.events().pipe(switchMap(events => {\n    var _events$createdAtHash2;\n\n    const items = events.filter(({\n      event: {\n        data: [eventParaId],\n        method,\n        section\n      }\n    }) => section === 'crowdloan' && ['AllRefunded', 'Dissolved', 'PartiallyRefunded'].includes(method) && eventParaId.eq(paraId));\n    return items.length ? of(((_events$createdAtHash2 = events.createdAtHash) === null || _events$createdAtHash2 === void 0 ? void 0 : _events$createdAtHash2.toHex()) || '-') : EMPTY;\n  }), startWith('-'));\n}\n\nfunction _getKeysPaged(api, childKey) {\n  const startSubject = new BehaviorSubject(undefined);\n  return startSubject.pipe(switchMap(startKey => api.rpc.childstate.getKeysPaged(childKey, '0x', PAGE_SIZE_K, startKey)), tap(keys => {\n    setTimeout(() => {\n      keys.length === PAGE_SIZE_K ? startSubject.next(keys[PAGE_SIZE_K - 1].toHex()) : startSubject.complete();\n    }, 0);\n  }), toArray(), // toArray since we want to startSubject to be completed\n  map(keyArr => arrayFlatten(keyArr)));\n}\n\nfunction _getAll(api, paraId, childKey) {\n  return _eventTriggerAll(api, paraId).pipe(switchMap(() => // FIXME Needs testing and being enabled\n  // eslint-disable-next-line no-constant-condition\n  isFunction(api.rpc.childstate.getKeysPaged) && false ? _getKeysPaged(api, childKey) : api.rpc.childstate.getKeys(childKey, '0x')), map(keys => keys.map(k => k.toHex())));\n}\n\nfunction _contributions(api, paraId, childKey) {\n  return combineLatest([_getAll(api, paraId, childKey), _getUpdates(api, paraId)]).pipe(map(([keys, {\n    added,\n    blockHash,\n    removed\n  }]) => {\n    const contributorsMap = {};\n    keys.forEach(k => {\n      contributorsMap[k] = true;\n    });\n    added.forEach(k => {\n      contributorsMap[k] = true;\n    });\n    removed.forEach(k => {\n      delete contributorsMap[k];\n    });\n    return {\n      blockHash,\n      contributorsHex: Object.keys(contributorsMap)\n    };\n  }));\n}\n\nexport function contributions(instanceId, api) {\n  return memo(instanceId, paraId => api.derive.crowdloan.childKey(paraId).pipe(switchMap(childKey => childKey ? _contributions(api, paraId, childKey) : of({\n    blockHash: '-',\n    contributorsHex: []\n  }))));\n}"]},"metadata":{},"sourceType":"module"}